<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profile - CyberLabs Fortress</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
  <script src="scripts/auth.js"></script>
  <script src="scripts/labs.js"></script>
  <script src="scripts/common.js"></script>
  <script src="scripts/badges.js"></script>
</head>
<body data-protected="true">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="index.html">CyberLabs Fortress</a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="content.html">Labs</a></li>
        <li class="nav-item d-none nav-profile"><a class="nav-link active" href="profile.html">Profile</a></li>
      </ul>
    </div>
  </div>
</nav>

<main class="container py-5">
  <div class="row">
    <div class="col-lg-4">
      <div class="card p-3 mb-4">
        <h5>Account</h5>
        <p><strong>Username:</strong> <span id="pUsername"></span></p>
        <p><strong>Email:</strong> <span id="pEmail"></span></p>
        <p><strong>Role:</strong> <span id="pRole"></span></p>
        <div class="d-grid gap-2">
          <button id="btnLogout" class="btn btn-outline-danger">Logout</button>
          <button id="btnResetPassword" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#resetPasswordModal">Reset Password</button>
          <!-- Admin panel link - only visible to admin users -->
          <a id="adminLink" class="btn btn-outline-warning d-none" href="admin.html">Admin Panel</a>
        </div>
      </div>
      
      <div class="card p-3 mb-4">
        <h5>Badges & Achievements</h5>
        <div id="badgesContainer" class="badge-container">
          <!-- Badges will be populated here -->
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="card p-3 mb-4">
        <h5>Progress Overview</h5>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="completedLabs">0</div>
            <div class="stat-label">Labs Completed</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalScore">0%</div>
            <div class="stat-label">Average Score</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="currentStreak">0</div>
            <div class="stat-label">Day Streak</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalBadges">0</div>
            <div class="stat-label">Badges Earned</div>
          </div>
        </div>
        
        <h6 class="mt-4">Category Progress</h6>
        <div id="categoryProgress">
          <!-- Category progress bars will be populated here -->
        </div>
      </div>

      <div class="card p-3">
        <h5>Lab Progress</h5>
        <div class="d-flex justify-content-between align-items-center mb-3">
          <span id="progressSummary">Loading...</span>
          <div>
            <select id="labFilter" class="form-select form-select-sm">
              <option value="all">All Labs</option>
              <option value="completed">Completed Only</option>
              <option value="incomplete">Incomplete Only</option>
            </select>
          </div>
        </div>
        <div id="labsList"></div>
      </div>
    </div>
  </div>
</main>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Reset Password</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="resetAlert" class="alert d-none"></div>
        <form id="resetPasswordForm">
          <div class="mb-3">
            <label class="form-label">Current Password</label>
            <input type="password" class="form-control" id="currentPassword" required>
          </div>
          <div class="mb-3">
            <label class="form-label">New Password</label>
            <input type="password" class="form-control" id="newPassword" minlength="6" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Confirm New Password</label>
            <input type="password" class="form-control" id="confirmPassword" minlength="6" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="submitResetPassword">Reset Password</button>
      </div>
    </div>
  </div>
</div>

<script>
// Get labs from localStorage
function getLabs() {
  try {
    return JSON.parse(localStorage.getItem('clf_labs')) || [];
  } catch (e) {
    return [];
  }
}

(function(){
  const current = getCurrentUsername();
  if(!current) return window.location.href = 'login.html';
  const user = getCurrentUserObj();
  document.getElementById('pUsername').textContent = user.username;
  document.getElementById('pEmail').textContent = user.email;
  document.getElementById('pRole').textContent = user.role;

  // Show admin link only for admin users
  if (user.role === 'admin') {
    document.getElementById('adminLink').classList.remove('d-none');
  }

  document.getElementById('btnLogout').onclick = () => logoutUser();

  // Load badges
  displayUserBadges(user);
  
  // Calculate and display stats
  calculateAndDisplayStats(user);

  // Setup password reset functionality
  document.getElementById('submitResetPassword').onclick = function() {
    const currentPw = document.getElementById('currentPassword').value;
    const newPw = document.getElementById('newPassword').value;
    const confirmPw = document.getElementById('confirmPassword').value;
    const alertBox = document.getElementById('resetAlert');
    
    alertBox.classList.add('d-none');
    
    if (newPw !== confirmPw) {
      alertBox.textContent = 'New passwords do not match';
      alertBox.classList.remove('d-none', 'alert-success');
      alertBox.classList.add('alert-danger');
      return;
    }
    
    if (newPw.length < 6) {
      alertBox.textContent = 'Password must be at least 6 characters';
      alertBox.classList.remove('d-none', 'alert-success');
      alertBox.classList.add('alert-danger');
      return;
    }
    
    try {
      // Verify current password
      loginUser({ username: user.username, password: currentPw });
      
      // Update password
      const users = getUsers();
      const userIndex = users.findIndex(u => u.username === user.username);
      if (userIndex !== -1) {
        users[userIndex].password = hashPassword(newPw);
        saveUsers(users);
        
        alertBox.textContent = 'Password updated successfully';
        alertBox.classList.remove('d-none', 'alert-danger');
        alertBox.classList.add('alert-success');
        
        // Clear form and close modal after 2 seconds
        setTimeout(() => {
          document.getElementById('resetPasswordForm').reset();
          bootstrap.Modal.getInstance(document.getElementById('resetPasswordModal')).hide();
        }, 2000);
      }
    } catch (err) {
      alertBox.textContent = 'Current password is incorrect';
      alertBox.classList.remove('d-none', 'alert-success');
      alertBox.classList.add('alert-danger');
    }
  };

  // Build lab list
  renderLabProgress(user);

  // Add filter functionality
  document.getElementById('labFilter').addEventListener('change', function() {
    renderLabProgress(user, this.value);
  });
})();

function calculateAndDisplayStats(user) {
  const labs = getLabs();
  const progress = user.progress || {};
  const completedLabs = Object.values(progress).filter(p => p && p.completedOverall).length;
  const totalScore = Object.values(progress).reduce((sum, p) => sum + (p.score || 0), 0);
  const avgScore = completedLabs > 0 ? Math.round(totalScore / completedLabs) : 0;
  
  // Calculate streak (simplified)
  const today = new Date();
  const lastCompletion = Object.values(progress)
    .filter(p => p && p.completedOverall && p.ts)
    .map(p => new Date(p.ts))
    .sort((a, b) => b - a)[0];
  
  let streak = 0;
  if (lastCompletion) {
    const diffTime = Math.abs(today - lastCompletion);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    if (diffDays <= 1) streak = 1; // Simplified logic
  }
  
  // Calculate category progress dynamically based on actual labs
  const categories = {};
  
  // Initialize categories from existing labs
  labs.forEach(lab => {
    if (!categories[lab.category]) {
      categories[lab.category] = { completed: 0, total: 0 };
    }
    categories[lab.category].total++;
    
    // Check if this lab is completed
    if (progress[lab.id] && progress[lab.id].completedOverall) {
      categories[lab.category].completed++;
    }
  });
  
  // Update stats display
  document.getElementById('completedLabs').textContent = completedLabs;
  document.getElementById('totalScore').textContent = `${avgScore}%`;
  document.getElementById('currentStreak').textContent = streak;
  document.getElementById('totalBadges').textContent = calculateBadgeCount(user);
  document.getElementById('progressSummary').textContent = `${completedLabs} / ${labs.length} labs completed`;
  
  // Render category progress
  let categoryHtml = '';
  for (const [category, data] of Object.entries(categories)) {
    const percent = data.total > 0 ? Math.round((data.completed / data.total) * 100) : 0;
    categoryHtml += `
      <div class="mb-2">
        <div class="d-flex justify-content-between">
          <span>${category}</span>
          <span>${data.completed}/${data.total} (${percent}%)</span>
        </div>
        <div class="progress">
          <div class="progress-bar" role="progressbar" style="width: ${percent}%"></div>
        </div>
      </div>
    `;
  }
  document.getElementById('categoryProgress').innerHTML = categoryHtml || '<p class="text-muted">No labs available</p>';
}

function renderLabProgress(user, filter = 'all') {
  const labs = getLabs();
  const progress = user.progress || {};
  const completedCount = Object.values(progress).filter(p => p && p.completedOverall).length;
  document.getElementById('progressSummary').textContent = `${completedCount} / ${labs.length} labs completed`;

  // Build list
  let html = '<ul class="list-group">';
  
  if (labs.length === 0) {
    html += '<li class="list-group-item text-center text-muted">No labs available</li>';
  } else {
    for (const lab of labs) {
      const s = progress[lab.id];
      const isCompleted = s && s.completedOverall;
      
      // Apply filter
      if (filter === 'completed' && !isCompleted) continue;
      if (filter === 'incomplete' && isCompleted) continue;
      
      const status = isCompleted ? 
        `<span class="badge bg-success">Completed (${s.score}%)</span>` : 
        `<span class="badge bg-secondary">Pending</span>`;
      
      const difficultyClass = lab.difficulty === 'beginner' ? 'badge-beginner' : 
                             lab.difficulty === 'intermediate' ? 'badge-intermediate' : 'badge-advanced';
      
      const ts = s && s.ts ? new Date(s.ts).toLocaleString() : '';
      
      html += `<li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <strong>${lab.title}</strong> 
          <span class="badge ${difficultyClass}">${lab.difficulty}</span>
          <span class="badge badge-category">${lab.category}</span>
          <br>
          ${status}
          <small class="text-muted">${ts}</small>
        </div>
        <div>
          <a href="${lab.link}" class="btn btn-sm btn-primary">Open Lab</a>
          ${ s ? `<button class="btn btn-sm btn-outline-secondary ms-2" onclick="showLabAnswers('${lab.id}')">Answers</button>` : '' }
        </div>
      </li>`;
    }
  }
  
  html += '</ul>';
  document.getElementById('labsList').innerHTML = html;
}

// function to show answers in modal-like alert
function showLabAnswers(labId){
  const user = getCurrentUserObj();
  if(!user) return alert('Not signed in.');
  const p = user.progress && user.progress[labId];
  if(!p) return alert('No answers submitted yet for ' + labId);
  const answers = p.answers || {};
  const out = Object.keys(answers).map(k => `${k}: ${answers[k]}`).join('\n');
  alert(`Answers for ${labId}\nScore: ${p.score}%\n\n${out}`);
}
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>